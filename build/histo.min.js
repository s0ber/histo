/*! histo (v0.2.1),
 Library, which allows different widgets to register it's own history events handlers, which won't be conflicting with each others,
 by Sergey Shishkalov <sergeyshishkalov@gmail.com>
 Thu Jul 23 2015 */
(function(){var t;t={},null==window.modula&&(window.modula={"export":function(e,n){return t[e]=n},require:function(e){var n;if(n=t[e])return n;throw"Module '"+e+"' not found."}})}).call(this),function(){var t={}.hasOwnProperty;window.Histo=function(){function e(){}return e.addWidget=function(t){var e,n;return null==t&&(t={}),this._launcher().isInitialized()||this._launcher().initialize(),e=modula.require("histo/widget"),n=new e(t),null==this.widgets&&(this.widgets={}),this.widgets[n.id]=n},e.saveInitialStateAsCurrent=function(){return this.saveCurrentState(window.location.state||{})},e.currentState=function(){return this._currentState},e.saveCurrentState=function(t){return this._currentState=_.clone(t)},e.supplementState=function(t){var e,n,i,r,a,o;if(!this.isPopping)return n=t.id,a=t.widgetState,r=this._history().state||{},a.state_id=null!=(e=null!=(o=r[n])?o.state_id:void 0)?e:0,r[n]=a,i=t.path||location.href,this._history().replaceState(r,null,i),this.saveCurrentState(r)},e.replaceStateWithCurrent=function(){return null==this._history().state?this._history().replaceState(this.currentState(),null,location.href):void 0},e.pushNewState=function(t,e){var n,i,r;return this._launcher().onBeforePushState(),n=e.id,r=e.widgetState,r.state_id=this.currentState()[n].state_id+1,i=this.currentState(),i[n]=r,t=this._removeURIParameter(t,"_"),this._history().pushState(i,null,t),this.saveCurrentState(i)},e.onPopState=function(t){var e,n,i,r,a;return n=this._getChangedWidgetId(t),null!=n?(null!=this.currentChangedId&&this.currentChangedId===n&&null!=(a=this.dfd)&&a.reject(),this.currentChangedId=n,r=t[n],i=location.href,this.saveCurrentState(t),this.dfd=e=new $.Deferred,this._asyncFn().addToCallQueue(function(t){return function(){var a;return t.isPopping=!0,e.done(function(){return t.isPopping=!1}),a=t.widgets[n],a.callCallback(r,i,e),e.promise()}}(this))):void 0},e._getChangedWidgetId=function(e){var n,i,r,a,o,u;n=null;for(a in e)if(t.call(e,a)){o=e[a],u=this.currentState();for(i in u)if(t.call(u,i)&&(r=u[i],a===i&&o.state_id!==r.state_id&&1===Math.abs(o.state_id-r.state_id))){n=a;break}}return n},e._launcher=function(){return null!=this.__launcher?this.__launcher:this.__launcher=modula.require("histo/launcher")},e._asyncFn=function(){return null!=this.__asyncFn?this.__asyncFn:this.__asyncFn=window.AsyncFn},e._history=function(){return window.history},e._removeURIParameter=function(t,e){var n,i,r,a,o,u,s;if(t=t.toString(),o=t.split("?"),o.length<2)return t;for(a=encodeURIComponent(e)+"=",r=o[1].split(/[&;]/g),i=[],n=u=0,s=r.length;s>=0?s>u:u>s;n=s>=0?++u:--u)-1===r[n].lastIndexOf(a,0)&&i.push(r[n]);return t=i.length?o[0]+"?"+i.join("&"):o[0]},e}(),modula["export"]("histo",Histo)}.call(this),function(){var t,e;t=modula.require("histo"),e=function(){function e(){}return e.initialize=function(){return this._isInitialized=!0,this._fakeStatePopped=!1,this._initialUrl=location.href,window.onpopstate=_.bind(this._popState,this),window.onhashchange=_.bind(this._addCurrentStateOnHashChange,this),t.saveInitialStateAsCurrent()},e.unload=function(){return this._isInitialized=!1,this._fakeStatePopped=!1,window.onpopstate=null,window.onhashchange=null},e.isInitialized=function(){return this._isInitialized},e.onBeforePushState=function(){return this._fakeStatePopped=!0},e._popState=function(e){return location.href!==this._initialUrl||this._fakeStatePopped?(this._fakeStatePopped=!0,t.onPopState(null!=e?e.state:void 0)):void(this._fakeStatePopped=!0)},e._addCurrentStateOnHashChange=function(){return t.replaceStateWithCurrent()},e}(),modula["export"]("histo/launcher",e)}.call(this),function(){var t,e;t=modula.require("histo"),e=function(){function e(t){t.id&&(this.id=t.id,this.poppedStateCallback=null)}return e.prototype.onPopState=function(t){return this.poppedStateCallback=t},e.prototype.callCallback=function(t,e,n){return null!=this.poppedStateCallback?this.poppedStateCallback(t,e,n):void 0},e.prototype.replaceInitialState=function(t,e){return null==e&&(e=location.href),this.replaceState(t,e)},e.prototype.replaceState=function(e,n){return null==n&&(n=location.href),t.supplementState({id:this.id,widgetState:e,path:n})},e.prototype.pushState=function(e,n){return t.pushNewState(e,{id:this.id,widgetState:n})},e}(),modula["export"]("histo/widget",e)}.call(this);