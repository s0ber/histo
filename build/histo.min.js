/*! histo (v0.1.5),
 Library, which allows different widgets to register it's own history events handlers, which won't be conflicting with each others,
 by Sergey Shishkalov <sergeyshishkalov@gmail.com>
 Mon Aug 25 2014 */
(function(){var t;t={},null==window.modula&&(window.modula={"export":function(e,i){return t[e]=i},require:function(e){var i;if(i=t[e])return i;throw"Module '"+e+"' not found."}})}).call(this),function(){var t={}.hasOwnProperty;window.Histo=function(){function e(){}return e.addWidget=function(t){var e,i;return null==t&&(t={}),this._launcher().isInitialized()||this._launcher().initialize(),e=modula.require("histo/widget"),i=new e(t),null==this.widgets&&(this.widgets={}),this.widgets[i.id]=i},e.saveInitialStateAsCurrent=function(){return this.saveCurrentState(window.location.state||{})},e.currentState=function(){return this._currentState},e.saveCurrentState=function(t){return this._currentState=_.clone(t)},e.supplementState=function(t){var e,i,n,r,a;if(!this.isPopping)return i=t.id,r=t.widgetState,n=this._history().state||{},r.state_id=null!=(e=null!=(a=n[i])?a.state_id:void 0)?e:0,n[i]=r,this._history().replaceState(n,null,location.href),this.saveCurrentState(n)},e.pushNewState=function(t,e){var i,n,r;return this._launcher().onBeforePushState(),i=e.id,r=e.widgetState,r.state_id=this.currentState()[i].state_id+1,n=this.currentState(),n[i]=r,t=this._removeURIParameter(t,"_"),this._history().pushState(n,null,t),this.saveCurrentState(n)},e.onPopState=function(t){var e,i,n,r,a;return i=this._getChangedWidgetId(t),null!=i?(null!=this.currentChangedId&&this.currentChangedId===i&&null!=(a=this.dfd)&&a.reject(),this.currentChangedId=i,r=t[i],n=location.href,this.saveCurrentState(t),this.dfd=e=new $.Deferred,this._asyncFn().addToCallQueue(function(t){return function(){var a;return t.isPopping=!0,e.done(function(){return t.isPopping=!1}),a=t.widgets[i],a.callCallback(r,n,e),e.promise()}}(this))):void 0},e._getChangedWidgetId=function(e){var i,n,r,a,o,u;i=null;for(a in e)if(t.call(e,a)){o=e[a],u=this.currentState();for(n in u)if(t.call(u,n)&&(r=u[n],a===n&&o.state_id!==r.state_id&&1===Math.abs(o.state_id-r.state_id))){i=a;break}}return i},e._launcher=function(){return null!=this.__launcher?this.__launcher:this.__launcher=modula.require("histo/launcher")},e._asyncFn=function(){return null!=this.__asyncFn?this.__asyncFn:this.__asyncFn=window.AsyncFn},e._history=function(){return window.history},e._removeURIParameter=function(t,e){var i,n,r,a,o,u,s;if(t=t.toString(),o=t.split("?"),o.length<2)return t;for(a=encodeURIComponent(e)+"=",r=o[1].split(/[&;]/g),n=[],i=u=0,s=r.length;s>=0?s>u:u>s;i=s>=0?++u:--u)-1===r[i].lastIndexOf(a,0)&&n.push(r[i]);return t=n.length?o[0]+"?"+n.join("&"):o[0]},e}(),modula["export"]("histo",Histo)}.call(this),function(){var t,e;t=modula.require("histo"),e=function(){function e(){}return e.initialize=function(){return this._isInitialized=!0,this._fakeStatePopped=!1,this._initialUrl=location.href,window.onpopstate=_.bind(this._popState,this),t.saveInitialStateAsCurrent()},e.unload=function(){return this._isInitialized=!1,this._fakeStatePopped=!1,window.onpopstate=null},e.isInitialized=function(){return this._isInitialized},e.onBeforePushState=function(){return this._fakeStatePopped=!0},e._popState=function(e){return location.href!==this._initialUrl||this._fakeStatePopped?(this._fakeStatePopped=!0,t.onPopState(null!=e?e.state:void 0)):void(this._fakeStatePopped=!0)},e}(),modula["export"]("histo/launcher",e)}.call(this),function(){var t,e;t=modula.require("histo"),e=function(){function e(t){t.id&&(this.id=t.id,this.poppedStateCallback=null)}return e.prototype.onPopState=function(t){return this.poppedStateCallback=t},e.prototype.callCallback=function(t,e,i){return null!=this.poppedStateCallback?this.poppedStateCallback(t,e,i):void 0},e.prototype.replaceInitialState=function(e){return t.supplementState({id:this.id,widgetState:e})},e.prototype.pushState=function(e,i){return t.pushNewState(e,{id:this.id,widgetState:i})},e}(),modula["export"]("histo/widget",e)}.call(this);