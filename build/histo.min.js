/*! histo (v0.1.0),
 Library, which allows different widgets to register it's own history events handlers, which won't be conflicting with each others,
 by Sergey Shishkalov <sergeyshishkalov@gmail.com>
 Thu Jun 26 2014 */
(function(){var t;t={},null==window.modula&&(window.modula={"export":function(e,i){return t[e]=i},require:function(e){var i;if(i=t[e])return i;throw"Module '"+e+"' not found."}})}).call(this),function(){var t={}.hasOwnProperty;window.Histo=function(){function e(){}return e.addWidget=function(t){var e,i;return null==t&&(t={}),this._launcher().isInitialized()||this._launcher().initialize(),e=modula.require("histo/widget"),i=new e(t),null==this.widgets&&(this.widgets={}),this.widgets[i.id]=i},e.saveInitialStateAsCurrent=function(){return this.saveCurrentState(window.location.state||{})},e.currentState=function(){return this._currentState},e.saveCurrentState=function(t){return this._currentState=_.clone(t)},e.supplementState=function(t){var e,i,n,a,r;return i=t.id,a=t.widgetState,n=this._history().state||{},a.state_id=null!=(e=null!=(r=n[i])?r.state_id:void 0)?e:0,n[i]=a,this._history().replaceState(n,null,location.href),this.saveCurrentState(n)},e.pushNewState=function(t,e){var i,n,a;return this._launcher().onBeforePushState(),i=e.id,a=e.widgetState,a.state_id=this.currentState()[i].state_id+1,n=this.currentState(),n[i]=a,t=this._removeURIParameter(t,"_"),this._history().pushState(n,null,t),this.saveCurrentState(n)},e.onPopState=function(t){var e,i,n;return e=this._getChangedWidgetId(t),null!=e?(i=this.widgets[e],n=t[e],this.saveCurrentState(t),i.callCallbacks(n)):void 0},e._getChangedWidgetId=function(e){var i,n,a,r,o,u;i=null;for(r in e)if(t.call(e,r)){o=e[r],u=this.currentState();for(n in u)if(t.call(u,n)&&(a=u[n],r===n&&o.state_id!==a.state_id&&1===Math.abs(o.state_id-a.state_id))){i=r;break}}return i},e._launcher=function(){return null!=this.__launcher?this.__launcher:this.__launcher=modula.require("histo/launcher")},e._history=function(){return window.history},e._removeURIParameter=function(t,e){var i,n,a,r;if(t=t.toString(),r=t.split("?"),r.length<2)return t;for(a=encodeURIComponent(e)+"=",n=r[1].split(/[&;]/g);i=n.length&&i--;)-1!==n[i].lastIndexOf(a,0)&&n.splice(i,1);return t=n.length?r[0]+"?"+n.join("&"):r[0]},e}(),modula["export"]("histo",Histo)}.call(this),function(){var t,e;t=modula.require("histo"),e=function(){function e(){}return e.initialize=function(){return this._isInitialized=!0,this._fakeStatePopped=!1,this._initialUrl=location.href,window.onpopstate=_.bind(this._popState,this),t.saveInitialStateAsCurrent()},e.unload=function(){return this._isInitialized=!1,this._fakeStatePopped=!1,window.onpopstate=null},e.isInitialized=function(){return this._isInitialized},e.onBeforePushState=function(){return this._fakeStatePopped=!0},e._popState=function(e){return location.href!==this._initialUrl||this._fakeStatePopped?(this._fakeStatePopped=!0,t.onPopState(null!=e?e.state:void 0)):void(this._fakeStatePopped=!0)},e}(),modula["export"]("histo/launcher",e)}.call(this),function(){var t,e;t=modula.require("histo"),e=function(){function e(t){t.id&&(this.id=t.id,this.poppedStateCallbacks=[])}return e.prototype.onPopState=function(t){return this.poppedStateCallbacks.push(t)},e.prototype.callCallbacks=function(t){var e,i,n,a,r;for(a=this.poppedStateCallbacks,r=[],i=0,n=a.length;n>i;i++)e=a[i],r.push(e(t));return r},e.prototype.replaceInitialState=function(e){return t.supplementState({id:this.id,widgetState:e})},e.prototype.pushState=function(e,i){return t.pushNewState(e,{id:this.id,widgetState:i})},e}(),modula["export"]("histo/widget",e)}.call(this);